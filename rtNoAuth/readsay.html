%# Copyright (C) 2006   Software Freedom Law Center, Inc.
%# Author: Orion Montoya <orion@mdcclv.com>
%#
%# This software gives you freedom; it is licensed to you under version
%# 3 of the GNU Affero General Public License, along with the
%# additional permission in the following paragraph.
%#
%# This notice constitutes a grant of such permission as is necessary
%# to combine or link this software, or a modified version of it, with
%# Request Tracker (RT), published by Jesse Vincent and Best Practical
%# Solutions, LLC, or a derivative work of RT, and to copy, modify, and
%# distribute the resulting work.  RT is licensed under version 2 of
%# the GNU General Public License.
%# 
%# This software is distributed WITHOUT ANY WARRANTY, without even the
%# implied warranties of MERCHANTABILITY and FITNESS FOR A PARTICULAR
%# PURPOSE.  See the GNU Affero General Public License for further
%# details.
%#  
%# You should have received a copy of the GNU Affero General Public
%# License, version 3, and the GNU General Public License, version 2,
%# along with this software.  If not, see <http://www.gnu.org/licenses/>.
%
<html>
<head>
    <title>read GPLv3 comments: <% humanQuery($ARGS{'Query'}) %></title>
    <link rel="stylesheet" type="text/css" href="/comments/stet.css"/>
</head>
<body>
<div id="maintext">
% if ($Tickets) {
<h3> Showing comments where <% humanQuery($ARGS{'Query'}) |n %> <a class="rsslink" href="<% $rsslink %>">[rss]</a><h3>
<h4>Found <% $Tickets->CountAll()%></h4>
% } else {
<h3> Showing comment <% $ARGS{'id'} %> <a class="rsslink" href="<% $rsslink %>">[rss]</a></h3>
% }
%
% while (my $item = $Tickets ? $Tickets->Next : $Ticket) {
<div class="onecomment">
<& /Elements/ListActions, actions => \@msgresults &>
<& /Elements/ListActions, actions => \@linkresults &>
<h4><a href="readsay.html?id=<% $item->id %>"><% $item->id %>: <% $item->Subject %></a></h4>
<span class="tktheader">Regarding the text:</span> <span class="ontextText"><% $scrubber->scrub($item->FirstCustomFieldValue('NoteSelection')) %></span><br/>
In section: <span class="nodeLink"><% $scrubber->scrub($item->FirstCustomFieldValue('NoteStartNodeId')) %></span><br/>
Submitted by: <% $item->CreatorObj->Name %><br/>
% my ($agree,$agr_count) = showAgree(\$item);
% print STDERR "agree is $agree\n";
<% $agree |n %><br/>
<span class="agreecount"><% $agr_count %> agree</span></span><br/>
comments: <% getThread(\$item) |n %><br/>
% if (($makeissue) && ($item->Queue != $issuequeue)) {
<input type="checkbox" value="1" name="MakeIssue"/>Upgrade this to an Issue<br/>
% }
Parents:
% while (my $link = $item->MemberOf->Next) {
      <INPUT TYPE=CHECKBOX NAME="DeleteLink--<%$link->Type%>-<%$link->Target%>" value="1">
        <& ShowLink, URI => $link->TargetURI &><br>
% }
<br/>
Children:
% while (my $link = $Object->Members->Next) {
      <INPUT TYPE=CHECKBOX NAME="DeleteLink-<%$link->Base%>-<%$link->Type%>-" value="1">
        <& ShowLink, URI => $link->BaseURI &><br>
% }
% if ($resp == 1) {
<form action="readsay.html" method="POST" name="TicketUpdate" enctype="multipart/form-data">
<input type="hidden" name="id" value="<% $item->id %>">
<textarea class="messagebox" COLS=72 ROWS=15 WRAP=HARD NAME="UpdateContent" onfocus="if(this.value=='Enter additional comments here') {this.value='';}" onblur="if(this.value==''){this.value='Enter additional comments here';}">
% if($ARGS{'addcomments'}) {
<% $ARGS{'addcomments'} %>
% }
% else {
Enter additional comments here
% }
</textarea><br/>
% if ($makeissue) {
<INPUT TYPE=SUBMIT NAME="SubmitTicket" VALUE='Make changes'></form>
% } else {
<INPUT TYPE=SUBMIT NAME="SubmitTicket" VALUE='Add comment'></form>
% }
% }
</div>
% $Ticket = '';
% }

</body>
</html>
%
%
%
%
<%INIT>

use CGI qw/:standard/;
use HTML::Scrubber;
my $scrubber = HTML::Scrubber->new( allow => [ qw[ a b i u br ] ] );
require "/var/www/stet/stetsubs.pl";
my $issuequeue = 4; # I guess Issue will be queue 4...
sub debug {
    print STDERR @_ . "\n";
}

my ($name, $resp, $pass, $agr_vals, $CurrentUser);
($CurrentUser, $resp) = getUser("foo");

my $rsslink = "/rt/NoAuth/rssresults.rdf?Query=".$ARGS{'Query'};

my ($Tickets, $Ticket, $makeissue, @msgresults, @linkresults);

if ($ARGS{'Query'}) {
    $Tickets = RT::Tickets->new($CurrentUser);
    $Tickets->FromSQL($ARGS{'Query'});
    $Tickets->OrderBy( FIELD => 'id', ORDER => $ARGS{'Order'});
}
elsif ($ARGS{'id'}) {
    $Ticket = RT::Ticket->new($CurrentUser);
    $Ticket = LoadTicket($ARGS{'id'});
    if ($ARGS{'UpdateContent'}) {
	ProcessUpdateMessage(TicketObj => $item, ARGSRef=>\%ARGS, Actions=>\@msgresults);

    }
    if ($ARGS{'MakeIssue'}) {
	$Ticket->SetQueue($issuequeue);
    }
    @linkresults = ProcessTicketLinks( TicketObj => $Ticket, ARGSRef => \%ARGS);
}

my $NewQueueObj = RT::Queue->new( $CurrentUser );
$NewQueueObj->Load($issuequeue); 

if (
    (
        $CurrentUser->HasRight(
            Right    => 'CreateTicket',
            Object => $NewQueueObj
        )
      )
    {
	$makeissue = 1;
    }

sub getThread($) {
    my $itemref = shift;
    my $item = $$itemref;
    my $Transactions = $item->Transactions;
    my $allcomments = '';
    our $scrubber;
    while (my $Transaction = $Transactions->Next) {
	next unless ($Transaction->Type =~ /^(Create|Correspond|Comment$)/);
		     
		     my $attachments = $Transaction->Attachments;
#    my $CustomFields = $item->QueueObj->TicketCustomFields();
		     my $CustomFields = $item->QueueObj->CustomFields();
		     $attachments->GotoFirstItem;
		     while (my $message = $attachments->Next) {
#			 $allcomments .= $Transaction->Content;
			 my ($subj, $cont) = ('');
			 if ($message->Subject != '') {
			     $subj = $scrubber->scrub($message->Subject);
			 }
			 $cont = sprintf("%s",$message->Content);
# 			 if ($message->Content != '') {
# 			     $cont = $scrubber->scrub($cont);
# 			 }
# 			 if ($cont = $message->Content) {
#			     $cont = $scrubber->scrub($cont);
#			 }

			 $allcomments .= "<blockquote><h4>$subj</h4>\n$cont<br/>\n";
			 $allcomments .= "<span class=\"posted\">noted by user <span class=\"userlink\">".$message->CreatorObj->Name."</span></span>\n";
		     }
		     $allcomments .= "</blockquote>" x $attachments->Count;
		 }
	
	return $allcomments;
}


</%INIT>
